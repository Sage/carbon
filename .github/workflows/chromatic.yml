name: Chromatic

on:
  workflow_dispatch:
    inputs:
      number:
        description: "Pull Request Number"
        required: true

jobs:
  check:
    name: "Check head branch name"
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.get_head_branch_name.outputs.name }}
    steps:
      - id: get_head_branch_name
        name: "Get head branch name"
        run: |
          branchName=$(gh pr view ${{ github.event.inputs.number }} --json headRefName --jq ".headRefName" --repo $GITHUB_REPOSITORY)
          echo "name=$branchName" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - id: escape_characters_check
        name: Check for any escape characters
        run: |
          if ${{ contains(steps.get_head_branch_name.outputs.name, '"') }}
          then
            exit 1
          else
            exit 0
          fi

  chromatic:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: "refs/pull/${{ github.event.inputs.number }}/head"
          fetch-depth: 0

      - uses: actions/setup-node@v3
        with:
          node-version: ">=18.12.1 18"

      - name: Install dependencies
        run: npm ci

      - name: Run chromatic on branch
        run: npx chromatic@latest --project-token ${{ secrets.CHROMATIC_PROJECT_TOKEN }} --exit-once-uploaded --branch-name="${{ needs.check.outputs.branch_name }}"
