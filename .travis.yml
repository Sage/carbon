language: node_js
node_js: node

cache:
  npm: true
  directories:
    - ~/.cache

# We build PR's and branches, this tells travis to only build on the master branch or PR's that target the master branch
branches:
  only:
  - master

addons:
   apt:
     packages:
       # Ubuntu 16+ does not install this dependency by default, so we need to install it ourselves
       - libgconf-2-4

stages:
  - test
  - regression
  - deploy

jobs:
  fast_finish: true
  include:
    - stage: test
      name: "lint"
      script: 
        - npm run lint
        - npm run lint-ts
    - name: "unit tests"
      script: npm test
    - name: "test build"
      script: npm run test-carbon-build
      if: type = pull_request # we only need to test this in a pull, on a push to master we will be running the build in the deploy step
    - name: "build cypress tests"
      script:
        - npm start -- --ci </dev/null &>/dev/null &
        - wait-on http://localhost:9001
        - npm run test-cypress-build
    - &cypress-travis-regression
      stage: regression
      name: "cypress regression"
      script:
        - npm run storybook-ci </dev/null &>/dev/null &
        - wait-on http://localhost:9001
        - npm run cypress-travis-regression
      if: type = cron # we only need to run regression on nightly cron builds
      env: SUITE=accessibility/accessibility.feature
      - <<: *cypress-travis-regression
      env: SUITE=build/build.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/alert.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/animatedMenuButton.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/appWrapper.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/button.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/buttonAsSibling.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/buttonToggle.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/card.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/carousel.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/configurableItems.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/configurableItemsEvents.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/confirm.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/content.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/create.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/checkbox.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/dateInput.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/dateRange.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/decimalInput.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/dropdown.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/fieldset.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/form.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/groupedCharacter.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/numberInput.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/radioButton.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/simpleColorPicker.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/switch.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/textarea.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/deprecated/textbox.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/detail.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/dialog.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/dialogFullScreen.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/dialogFullScreenWithStickyFooter.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/draggableContext.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/checkbox.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/dateInput.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/dateRange.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/decimalInput.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/decimalPrecision.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/fieldset.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/form.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/groupedCharacter.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/numberInput.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/radioButtonGroup.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/select.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/selectMultiple.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/simpleColorPicker.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/textarea.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/textbox.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/experimental/textboxMultiple.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/filterComponent.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/heading.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/help.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/i18nComponent.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/iconTypePart1.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/iconTypePart2.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/inlineInputs.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/link.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/loader.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/loaderLegacySpinner.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/menu.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/menuList.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/message.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/mountInApp.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/navigationBar.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/pager.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/pages.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/pill.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/pod.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/portrait.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/preview.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/profile.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/radioButtonMonthly.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/radioButtonWeekly.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/radioButtonYearly.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/rainbow.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/row.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/settingsRow.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/showEditPod.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/sidebar.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/sidebarWithButton.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/splitButton.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/stepSequence.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/stepSequenceItem.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/table.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/tableAjax.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/tableWithInputs.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/tabs.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/accordion.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/accordionGrouped.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/actionPopoverEventsInIFrame.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/actionPopoverNoIFrame.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/anchorNavigation.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/badge.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/batchSelection.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/buttonToggleGroup.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/draggableNoIFrame.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/duellingPicklistNoIFrame.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/flatTableIniFrame.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/flatTableNoiFrame.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/grid.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/popoverContainer.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/test/search.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/tile.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/toast.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/checkboxValidations.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/dateInputValidations.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/radioButtonValidations.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/selectValidations.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/switchValidations.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/textareaValidations.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/textboxValidations.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/validationsBasic.feature
      - <<: *cypress-travis-regression
      env: SUITE=regression/validations/validationsTextboxBased.feature
      - <<: *cypress-travis-regression
      env: SUITE=themes/themes.feature
    - stage: deploy
      name: "s3"
      script: skip
      before_deploy: ASSETS_PREFIX=https://carbon.sage.com npm run build-storybook
      deploy:
          provider: s3
          on:
            branch: master
          bucket: carbon.sage.com
          skip_cleanup: true
          local_dir: storybook-static
          detect_encoding: true
          access_key_id:
            secure: iZx7SkuMjUMXLVQNO5LSjF6EfQeqGbgdGtPg0hfzVIEcS5s/79j5aq8aQJ7EjCXM+yPRDZMaXB+StXOZjNhEbKLYt2mZDyMki3gAII2QM2MAeI5YtltgJHlXClsMjFiomTbRPo/F9CnIerRBdAFUmQXh2BVSdz86ptsLWs9SrcSjgN/RM6bWSaFYbyckyRVQZVipHYN1vmbEw8ZNZGSQTEPyi3Pw4nXMJ+9ro/72Pt5Ioo3a/praWJL9I5hEc6uBAfFZTtsg70txARaSOycoHxQT8S/xfIzfPQXSmj3n4MTMMCOi3CyJFJfTOdHnQ2ylSllae3zLgIJv1dPQoRuPrB0A1loG2BA+1PXA7KZrwBzYty20XMM2o2tB4mlkKh8p1gOjdsAyRT415kDkEvGpw/b+jFPQ+mAg67ELCJz/HTvBvrKF8nAGsoiG0A1Bi89wxi2riMjAZ2VzbTHrTq/Lp/MlJYt4Z44CXVSKXlKBVKwlDVS7+OIp5QAC0AggtJGFb4kvS/6zUnoykM/lsRBX99lsMURlpGq/EKC5B4iU26NWvF4L+sO9UUesN7LMr8C6oSc7wVrhLHiQbJx55UZTjT4+H/Y4VOFOiEhVKKJTk0/jt/QOOxZbuyhMitLOMBTQQ9tEICv7fIFSUIfePD3bG6FR3vXvod0ct/H7/DhNM0A=
          secret_access_key:
            secure: qdS1pq1ZXvw6lXLrGtSaZTpx7OLREvV/7UCwPFbfQkuQBLbxLe32qlzOkkEQWd7sHwadSgvVTKvX4HKaAIx+QZ2XXFbXGx4HIOCws6ynAVVa2kV5SSHKMwiy+R6Ypttu3GD6uKEhPMUULCYuCLzIIvAOKoCaDIzzKlxzK+g/tCe94J+fKU0DS6U23FFxW51UADgTxn7opg3mkhsteaRyAtDkurAeobEzfQpTFKPNXJ3YcFjpGUf9Z5zxcXXNohKZQP4wODgYU+OZuif/cAeETChWxVThk0PMIIk9/lmwyX1UKIpWpyVTDEKXzwnO2COVWOxtVCpTB0uwfZTZ8MhVXRvFj8Dk/iw+2NN/W55fQ44xx0h6mvhMle98jKTWi6AR/F0LJMpCkZeNTVCdiDz7Ow1g23HlBIRx/seYxph2vLSLkh63kU8ygaOFWhCNdCGOOPLHi8m8X8vlLRvN9ETWY/sMWkvY/S9bXIGw8lv5Bk4lIxAmjoU05XJceq5rOlSax46d1fsicJ5gF6tcxvMau2bFGMCgeZJEpRYChqTEt284woFc8+maa4SwMVrim6J8R53Xfx8mtgCnRlgZmXymzyxu8wCVnAza24iQ4kWmx+fDw70iU5Q3nxSwjN4Q922QZiAFLGpAK0nRDFhE7NPftubYOgsisNCFOnTTTBGJghI=
    - name: "npm & GitHub"
      script: skip
      deploy:
        provider: script
        script: npx semantic-release
        skip_cleanup: true
        on:
          all_branches: true # semantic-release has a regex that allows us to publish maintenance releases